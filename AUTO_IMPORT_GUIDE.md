# מדריך ייבוא אוטומטי של ספרים

## תכונות חדשות שנוספו

### 1. ייבוא ספרים עם פס התקדמות וביטול

כעת כשמייבאים ספרים, תראה:
- **פס התקדמות** (LinearProgressIndicator) במקום עיגול טעינה
- **מונה ספרים**: "5 / 20" - מציג כמה ספרים עובדו מתוך הסך הכל
- **כפתור ביטול**: אפשר לעצור את התהליך בכל שלב
- **סטטוס מפורט**: מציג בדיוק מה קורה (ממיר, מאחד, וכו')

### 2. ייבוא אוטומטי של תיקיות חדשות

#### הפעלת התכונה:
1. פתח **הגדרות** → **כללי**
2. הפעל את **"ייבוא אוטומטי של תיקיות חדשות"**
3. כל תיקייה חדשה שתתווסף לספרייה תיובא אוטומטית למאגר

#### סריקה ידנית:
- לחץ על **"סרוק תיקיות חדשות עכשיו"** כדי לסרוק ולייבא תיקיות חדשות מיד
- השירות יזהה תיקיות שהשתנו מאז הסריקה האחרונה
- רק תיקיות עם קבצי טקסט (.txt, .text) ייובאו

### 3. איך זה עובד?

#### תהליך הייבוא:
1. **המרה**: קבצי הטקסט מומרים למאגר נתונים זמני
2. **חישוב Offsets**: המערכת מחשבת IDs ייחודיים למניעת התנגשויות
3. **גיבוי**: נוצר גיבוי אוטומטי של seforim.db
4. **מיזוג**: המאגר הזמני מתמזג עם seforim.db הראשי
5. **ניקוי**: המאגר הזמני נמחק

#### ביטול פעולה:
- לחיצה על "ביטול" תעצור את התהליך
- הקבצים שכבר עובדו לא יימחקו
- המאגר הזמני יימחק אוטומטית

### 4. דרישות מערכת

- **מיקום ספרייה**: חייב להיות מוגדר ב-"מיקום הספרייה"
- **seforim.db**: חייב להיות קיים בתיקיית הספרייה
- **קבצי טקסט**: התיקיות חייבות להכיל קבצי .txt או .text
- **WAL Mode**: המערכת מנסה להפעיל WAL mode לגישה מקבילית

### 4.1 בעיית נעילת מאגר הנתונים

**⚠️ חשוב:** SQLite לא מאפשר כתיבה מרובה למאגר נתונים בו זמנית.

**אם תראה שגיאה "לא ניתן לפתוח את מאגר הנתונים":**

1. **פתרון מומלץ**: סגור את האפליקציה והרץ את הייבוא מחוץ לאפליקציה:
   ```bash
   dart run tools/convert_books_to_db.dart <תיקייה> temp.db
   dart run tools/merge_databases.dart
   ```

2. **פתרון חלופי**: המערכת מנסה להפעיל WAL mode שמאפשר קריאה וכתיבה במקביל
   - אם זה עובד, תוכל לייבא בזמן שהאפליקציה רצה
   - אם לא, תצטרך לסגור את האפליקציה

**הדפסות Debug:**
כשמריצים ייבוא, תראה בקונסול:
- 🔄 Starting merge process...
- 📂 Main DB: [path]
- 🔓 Attempting to open main database...
- ✅ WAL mode enabled (או ⚠️ Could not enable WAL mode)
- ✅ Main database opened successfully (או ❌ Failed to open)

### 5. טיפים

#### לביצועים טובים יותר:
- ייבא תיקיות קטנות (עד 50 ספרים) בכל פעם
- השתמש בסריקה אוטומטית רק אם אתה מוסיף ספרים לעיתים קרובות
- בדוק את הגיבויים מדי פעם (seforim.db.backup.*)

#### פתרון בעיות:
- אם הייבוא נתקע, סגור את האפליקציה והפעל מחדש
- אם יש שגיאה, בדוק שהקבצים בקידוד UTF-8
- אם המאגר התקלקל, שחזר מגיבוי

### 6. קבצים שנוצרו

```
lib/services/database_import_service.dart  - שירות ייבוא עם תמיכה בביטול
lib/services/auto_import_service.dart      - שירות סריקה אוטומטית
lib/settings/settings_screen.dart          - עדכון עם UI חדש
```

### 7. הגדרות חדשות

- `key-auto-import-new-folders`: האם לייבא תיקיות חדשות אוטומטית
- `key-last-folder-scan`: חותמת זמן של הסריקה האחרונה

## שימוש מתקדם

### ייבוא תכנותי:

```dart
import 'package:otzaria/services/database_import_service.dart';

// ייבוא תיקייה
await DatabaseImportService.importBooksFromFolder(
  '/path/to/folder',
  '/path/to/seforim.db',
  (status, {current, total}) {
    print('$status - $current/$total');
  },
);

// ביטול
DatabaseImportService.cancelImport();
```

### סריקה אוטומטית:

```dart
import 'package:otzaria/services/auto_import_service.dart';

// סרוק ויבא תיקיות חדשות
await AutoImportService.scanAndImportNewFolders(
  onProgress: (status) => print(status),
);

// אפס סריקה אחרונה
await AutoImportService.resetLastScan();
```

## עדכונים עתידיים

תכונות שניתן להוסיף:
- [ ] תזמון סריקה אוטומטית (כל יום/שבוע)
- [ ] התראות על ספרים חדשים
- [ ] סינון תיקיות לפי שם
- [ ] ייבוא מרובה תיקיות בבת אחת
- [ ] היסטוריית ייבוא
